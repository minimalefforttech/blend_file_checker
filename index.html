<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blender File Python Script Analyzer</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@latest/build/styles/github.min.css" id="hljs-light-theme">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@latest/build/styles/github-dark.min.css" id="hljs-dark-theme" disabled>
    <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@latest/build/highlight.min.js"></script>
</head>
<body>
    <div class="container">
        <!-- Theme Toggle Button -->
        <button class="theme-toggle" id="themeToggle" aria-label="Toggle theme">
            <svg class="theme-toggle-icon" id="themeIcon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2.25a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0V3a.75.75 0 01.75-.75zM7.5 12a4.5 4.5 0 119 0 4.5 4.5 0 01-9 0zM18.894 6.166a.75.75 0 00-1.06-1.06l-1.591 1.59a.75.75 0 101.06 1.061l1.591-1.59zM21.75 12a.75.75 0 01-.75.75h-2.25a.75.75 0 010-1.5H21a.75.75 0 01.75.75zM17.834 18.894a.75.75 0 001.06-1.06l-1.59-1.591a.75.75 0 10-1.061 1.06l1.59 1.591zM12 18a.75.75 0 01.75.75V21a.75.75 0 01-1.5 0v-2.25A.75.75 0 0112 18zM7.758 17.303a.75.75 0 00-1.061-1.06l-1.591 1.59a.75.75 0 001.06 1.061l1.591-1.59zM6 12a.75.75 0 01-.75.75H3a.75.75 0 010-1.5h2.25A.75.75 0 016 12zM6.697 7.757a.75.75 0 001.06-1.06l-1.59-1.591a.75.75 0 00-1.061 1.06l1.59 1.591z" fill="currentColor"/>
            </svg>
        </button>

        <h1 class="analyzer-title">Blender Malicious File Checker</h1>
        
        <p class="help-blurb"></p>
            Scan Blender (.blend) files for suspicious scripts and code. This tool highlights potential risks, but may not detect every threat or support all file versions. Always review results and use caution with unknown files.
        </p>
        
        <div class="upload-area" id="uploadArea">
            <div class="upload-text">Drop your .blend file here or click to browse</div>
            <button class="btn">Choose File</button>
            <input type="file" id="fileInput" accept=".blend" />
        </div>

        <div class="progress" id="progressBar">
            <div class="progress-bar" id="progressFill"></div>
        </div>

        <div id="results" class="results"></div>
    </div>

    <script src="blend_text_extractor.js"></script>
    <script>
        class BlendFileAnalyzer {
            constructor() {
                this.extractor = new BlendFileTextExtractor();
                this.setupEventListeners();
            }

            setupEventListeners() {
                const fileInput = document.getElementById('fileInput');
                const uploadArea = document.getElementById('uploadArea');

                fileInput.addEventListener('change', (e) => this.handleFile(e.target.files[0]));

                // Drag and drop functionality
                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.classList.add('drag-over');
                });

                uploadArea.addEventListener('dragleave', () => {
                    uploadArea.classList.remove('drag-over');
                });

                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.classList.remove('drag-over');
                    const file = e.dataTransfer.files[0];
                    if (file) this.handleFile(file);
                });

                uploadArea.addEventListener('click', () => {
                    fileInput.click();
                });
            }

            async handleFile(file) {
                if (!file) return;
                
                const filename = file.name;
                if (!filename.toLowerCase().endsWith('.blend')) {
                    this.showError('Please select a .blend file');
                    return;
                }
                
                try {
                    this.showProgress(10);
                    
                    const arrayBuffer = await this.readFileAsArrayBuffer(file);
                    this.showProgress(30);
                    
                    const analysis = this.extractor.analyzeBlendFile(arrayBuffer);
                    this.showProgress(80);
                    
                    this.displayResults(filename, analysis);
                    this.showProgress(100);
                    this.hideProgress();
                } catch (error) {
                    console.error('Analysis error:', error);
                    this.showError(`Error analyzing file: ${error.message}`);
                    this.hideProgress();
                }
            }

            readFileAsArrayBuffer(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = () => reject(new Error('Failed to read file'));
                    reader.readAsArrayBuffer(file);
                });
            }

            displayResults(filename, analysis) {
                const resultsDiv = document.getElementById('results');
                
                let html = `
                    <div class="file-info">
                        <h3>File Analysis: ${filename}</h3>
                        <p><strong>Blender Version:</strong> ${analysis.version}</p>
                        <p><strong>Architecture:</strong> ${analysis.architecture}</p>
                        <p><strong>Total Blocks:</strong> ${analysis.totalBlocks}</p>
                        <p><strong>Text Blocks Found:</strong> ${analysis.textBlocks.length}</p>
                    </div>
                `;

                // Security overview
                html += this.generateSecurityOverview(analysis);

                // Overall risk assessment
                const overallRisk = this.assessOverallRisk(analysis);
                html += this.generateRiskAlert(overallRisk, analysis);

                // Display individual text blocks
                if (analysis.textBlocks.length > 0) {
                    html += '<h3 style="margin-top: 30px;">Text Blocks Found (Click to expand)</h3>';
                    
                    for (let i = 0; i < analysis.textBlocks.length; i++) {
                        const textBlock = analysis.textBlocks[i];
                        const scriptAnalysis = textBlock.analysis;
                        const scriptId = `script-${i}`;
                        
                        let riskClass = 'low-risk';
                        if (scriptAnalysis.riskLevel === 'high' || scriptAnalysis.isStartup) {
                            riskClass = 'high-risk';
                        } else if (scriptAnalysis.riskLevel === 'medium') {
                            riskClass = 'medium-risk';
                        }
                        
                        html += `
                            <div class="script-collapsible ${scriptAnalysis.isStartup ? 'startup-script' : ''}">
                                <button class="script-toggle collapsed" onclick="toggleScript('${scriptId}')">
                                    <div>
                                        <div style="font-size: 1.2em; margin-bottom: 5px;">
                                            ${scriptAnalysis.isStartup ? 'üö® STARTUP SCRIPT' : 'üìù Text Block'}: ${textBlock.name}
                                        </div>
                                        <div class="file-summary ${riskClass}">
                                            Risk Level: <strong>${scriptAnalysis.riskLevel.toUpperCase()}</strong> | 
                                            Warnings: <strong>${scriptAnalysis.warnings.length}</strong>
                                            ${scriptAnalysis.isStartup ? ' | <strong style="color: #dc3545;">Runs on Open</strong>' : ''}
                                        </div>
                                    </div>
                                </button>
                                
                                <div class="script-content-wrapper" id="${scriptId}">
                                    <div class="script-details">
                                        ${scriptAnalysis.isStartup ? `
                                            <div class="script-warnings">
                                                <h4>Startup Script Detected!</h4>
                                                <p>This script will automatically execute when the blend file is opened:</p>
                                                <ul>
                                                    ${scriptAnalysis.startupReasons.map(reason => `<li>${reason}</li>`).join('')}
                                                </ul>
                                            </div>
                                        ` : ''}
                                        
                                        ${scriptAnalysis.warnings.length > 0 ? `
                                            <div class="script-warnings">
                                                <h4>Security Warnings for this Script:</h4>
                                                ${scriptAnalysis.warnings.map(warning => `
                                                    <div class="warning-item ${scriptAnalysis.riskLevel}">
                                                        ${warning}
                                                    </div>
                                                `).join('')}
                                            </div>
                                        ` : ''}
                                        
                                        <div class="script-code-container">
                                            <div class="script-code-header">
                                                <button class="copy-btn" onclick="copyToClipboard('${scriptId}-code', this)" title="Copy code to clipboard">
                                                    üìã Copy
                                                </button>
                                            </div>
                                            <pre class="script-code" id="${scriptId}-code" data-raw-code="${btoa(encodeURIComponent(textBlock.content.slice(0, 3000)))}"><code class="language-python">${this.escapeHtml(textBlock.content.slice(0, 3000))}${textBlock.content.length > 3000 ? '\n\n... (truncated for display)' : ''}</code></pre>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                } else {
                    html += `
                        <div class="safe-alert">
                            <h3>NO TEXT BLOCKS DETECTED</h3>
                            <p>No text blocks were found in this blend file.</p>
                            <p><strong>Note:</strong> This doesn't guarantee the file is safe - scripts could be embedded in other ways.</p>
                        </div>
                    `;
                }

                resultsDiv.innerHTML = html;

                // Apply syntax highlighting to all code blocks after a short delay
                setTimeout(() => {
                    this.applySyntaxHighlighting();
                }, 10);
            }

            applySyntaxHighlighting() {
                // Use highlight.js to highlight all code blocks
                const codeElements = document.querySelectorAll('code.language-python');
                codeElements.forEach(element => {
                    hljs.highlightElement(element);
                });
            }

            generateSecurityOverview(analysis) {
                let startupScripts = 0;
                let highRiskScripts = 0;
                let totalWarnings = 0;

                for (const textBlock of analysis.textBlocks) {
                    const scriptAnalysis = textBlock.analysis;
                    if (scriptAnalysis.isStartup) startupScripts++;
                    if (scriptAnalysis.riskLevel === 'high') highRiskScripts++;
                    totalWarnings += scriptAnalysis.warnings.length;
                }

                return `
                    <div class="security-overview">
                        <h3>Security Assessment</h3>
                        
                        <div class="security-risk-grid">
                            <div class="risk-indicator ${startupScripts > 0 ? 'high' : 'safe'}">
                                <h4>Auto-Execution</h4>
                                <p>${startupScripts} startup script${startupScripts !== 1 ? 's' : ''} found</p>
                            </div>
                            
                            <div class="risk-indicator ${highRiskScripts > 0 ? 'high' : totalWarnings > 0 ? 'medium' : 'safe'}">
                                <h4>Risk Level</h4>
                                <p>${highRiskScripts > 0 ? 'High risk scripts' : totalWarnings > 0 ? 'Some warnings' : 'No major risks'}</p>
                            </div>
                            
                            <div class="risk-indicator ${totalWarnings > 5 ? 'high' : totalWarnings > 0 ? 'medium' : 'safe'}">
                                <h4>Total Warnings</h4>
                                <p>${totalWarnings} security issue${totalWarnings !== 1 ? 's' : ''} detected</p>
                            </div>
                            
                            <div class="risk-indicator ${analysis.textBlocks.length > 0 ? 'medium' : 'safe'}">
                                <h4>Text Content</h4>
                                <p>${analysis.textBlocks.length} text block${analysis.textBlocks.length !== 1 ? 's' : ''} found</p>
                            </div>
                        </div>
                    </div>
                `;
            }

            assessOverallRisk(analysis) {
                let highRisk = false;
                let mediumRisk = false;
                let hasStartup = false;

                for (const textBlock of analysis.textBlocks) {
                    const scriptAnalysis = textBlock.analysis;
                    if (scriptAnalysis.isStartup) hasStartup = true;
                    if (scriptAnalysis.riskLevel === 'high') highRisk = true;
                    if (scriptAnalysis.riskLevel === 'medium') mediumRisk = true;
                }

                if (hasStartup || highRisk) return 'high';
                if (mediumRisk) return 'medium';
                if (analysis.textBlocks.length > 0) return 'low';
                return 'safe';
            }

            generateRiskAlert(riskLevel, analysis) {
                let startupCount = analysis.textBlocks.filter(tb => tb.analysis.isStartup).length;
                let highRiskCount = analysis.textBlocks.filter(tb => tb.analysis.riskLevel === 'high').length;

                switch (riskLevel) {
                    case 'high':
                        return `
                            <div class="caution-alert">
                                <h3>Security Review Required</h3>
                                <p>This file contains code patterns that require careful review:</p>
                                <ul>
                                    ${startupCount > 0 ? `<li>${startupCount} script${startupCount !== 1 ? 's' : ''} configured for automatic execution</li>` : ''}
                                    ${highRiskCount > 0 ? `<li>${highRiskCount} script${highRiskCount !== 1 ? 's' : ''} using system-level functions</li>` : ''}
                                </ul>
                                <p><strong>Recommendation:</strong> Review script contents below before opening. Ensure you trust the file source.</p>
                            </div>
                        `;
                    case 'medium':
                        return `
                            <div class="warning-alert">
                                <h3>Code Review Recommended</h3>
                                <p>This file contains scripts with some patterns that warrant review.</p>
                                <p><strong>Recommendation:</strong> Check the script contents below to verify expected behavior.</p>
                            </div>
                        `;
                    case 'low':
                        return `
                            <div class="info-alert">
                                <h3>Scripts Present</h3>
                                <p>Python scripts detected with standard functionality.</p>
                                <p><strong>Note:</strong> Always review scripts from unknown sources as a security best practice.</p>
                            </div>
                        `;
                    default:
                        return `
                            <div class="safe-alert">
                                <h3>Analysis Complete</h3>
                                <p>No Python text blocks detected in this file.</p>
                                <p><strong>Note:</strong> Scripts could potentially be embedded in other formats not covered by this analysis.</p>
                            </div>
                        `;
                }
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            showProgress(percent) {
                const progressBar = document.getElementById('progressBar');
                const progressFill = document.getElementById('progressFill');
                progressBar.style.display = 'block';
                progressFill.style.width = percent + '%';
            }

            hideProgress() {
                setTimeout(() => {
                    document.getElementById('progressBar').style.display = 'none';
                }, 500);
            }

            showError(message) {
                const resultsDiv = document.getElementById('results');
                resultsDiv.innerHTML = `
                    <div class="error-message">
                        <h3>Error</h3>
                        <p>${message}</p>
                    </div>
                `;
            }
        }

        // Global function for toggling scripts
        function toggleScript(scriptId) {
            const contentWrapper = document.getElementById(scriptId);
            const toggle = contentWrapper.previousElementSibling;
            
            if (contentWrapper.classList.contains('expanded')) {
                contentWrapper.classList.remove('expanded');
                toggle.classList.add('collapsed');
            } else {
                contentWrapper.classList.add('expanded');
                toggle.classList.remove('collapsed');
            }
        }

        // Copy code to clipboard
        function copyToClipboard(elementId, button) {
            const codeElement = document.getElementById(elementId);
            let textToCopy;

            // If the element has raw code data, use that (preserves original formatting)
            if (codeElement.hasAttribute('data-raw-code')) {
                textToCopy = decodeURIComponent(atob(codeElement.getAttribute('data-raw-code')));
            } else {
                // Fallback to text content
                textToCopy = codeElement.textContent || codeElement.innerText;
            }

            navigator.clipboard.writeText(textToCopy).then(() => {
                // Visual feedback
                const originalText = button.textContent;
                button.textContent = '‚úÖ Copied!';
                button.classList.add('copied');

                setTimeout(() => {
                    button.textContent = originalText;
                    button.classList.remove('copied');
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy: ', err);
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = textToCopy;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    const originalText = button.textContent;
                    button.textContent = '‚úÖ Copied!';
                    button.classList.add('copied');

                    setTimeout(() => {
                        button.textContent = originalText;
                        button.classList.remove('copied');
                    }, 2000);
                } catch (fallbackErr) {
                    console.error('Fallback copy failed: ', fallbackErr);
                    button.textContent = '‚ùå Failed';
                    setTimeout(() => {
                        button.textContent = 'üìã Copy';
                    }, 2000);
                }
                document.body.removeChild(textArea);
            });
        }

        // Initialize the analyzer when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            new BlendFileAnalyzer();
            initializeTheme();
        });

        // Theme switching functionality
        function initializeTheme() {
            const themeToggle = document.getElementById('themeToggle');
            const themeIcon = document.getElementById('themeIcon');
            const body = document.body;

            // Check for saved theme preference, otherwise use system preference
            let savedTheme = localStorage.getItem('theme');
            if (!savedTheme) {
                // Check system preference
                const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
                savedTheme = prefersDark ? 'dark' : 'light';
            }

            body.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);
            updateHighlightJsTheme(savedTheme);

            // Listen for system theme changes
            if (window.matchMedia) {
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
                    // Only update if no manual preference is saved
                    if (!localStorage.getItem('theme')) {
                        const newTheme = e.matches ? 'dark' : 'light';
                        body.setAttribute('data-theme', newTheme);
                        updateThemeIcon(newTheme);
                        updateHighlightJsTheme(newTheme);
                    }
                });
            }

            // Theme toggle event listener
            themeToggle.addEventListener('click', () => {
                const currentTheme = body.getAttribute('data-theme');
                const newTheme = currentTheme === 'light' ? 'dark' : 'light';

                body.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                updateThemeIcon(newTheme);
                updateHighlightJsTheme(newTheme);
            });

            function updateThemeIcon(theme) {
                if (theme === 'dark') {
                    themeIcon.innerHTML = `
                        <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z" fill="currentColor"/>
                    `;
                } else {
                    themeIcon.innerHTML = `
                        <path d="M12 2.25a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0V3a.75.75 0 01.75-.75zM7.5 12a4.5 4.5 0 119 0 4.5 4.5 0 01-9 0zM18.894 6.166a.75.75 0 00-1.06-1.06l-1.591 1.59a.75.75 0 101.06 1.061l1.591-1.59zM21.75 12a.75.75 0 01-.75.75h-2.25a.75.75 0 010-1.5H21a.75.75 0 01.75.75zM17.834 18.894a.75.75 0 001.06-1.06l-1.59-1.591a.75.75 0 10-1.061 1.06l1.59 1.591zM12 18a.75.75 0 01.75.75V21a.75.75 0 01-1.5 0v-2.25A.75.75 0 0112 18zM7.758 17.303a.75.75 0 00-1.061-1.06l-1.591 1.59a.75.75 0 001.06 1.061l1.591-1.59zM6 12a.75.75 0 01-.75.75H3a.75.75 0 010-1.5h2.25A.75.75 0 016 12zM6.697 7.757a.75.75 0 001.06-1.06l-1.59-1.591a.75.75 0 00-1.061 1.06l1.59 1.591z" fill="currentColor"/>
                    `;
                }
            }

            function updateHighlightJsTheme(theme) {
                const lightTheme = document.getElementById('hljs-light-theme');
                const darkTheme = document.getElementById('hljs-dark-theme');
                
                if (theme === 'dark') {
                    lightTheme.disabled = true;
                    darkTheme.disabled = false;
                } else {
                    lightTheme.disabled = false;
                    darkTheme.disabled = true;
                }
            }
        }
    </script>
</body>
</html>